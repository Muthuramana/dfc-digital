pool:
  name: Hosted VS2017
  demands:
  - npm
  - node.js
  - DotNetFramework
  - msbuild
  - visualstudio
  - vstest
  - java

#Your build pipeline references the ‘BuildPlatform’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971
#Your build pipeline references the ‘BuildConfiguration’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971
#Your build pipeline references the ‘BuildConfiguration’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971
#Your build pipeline references the ‘BuildPlatform’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971
#Your build pipeline references the ‘BuildConfiguration’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971
#Your build pipeline references the ‘BuildConfiguration’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971
#Your build pipeline references the ‘BuildPlatform’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971

steps:
- task: NuGetToolInstaller@0
  displayName: 'Use NuGet 4.3.0'
  enabled: false

- task: NuGetRestore@1
  displayName: 'NuGet restore'
  inputs:
    solution: DFC.Digital/DFC.Digital.sln
    selectOrConfig: config
    nugetConfigPath: DFC.Digital/.nuget/NuGet.Config

- task: PowerShell@1
  displayName: 'Rename Config files'
  inputs:
    scriptType: inlineScript
    inlineScript: |
     cd $Env:BUILD_SOURCESDIRECTORY
     Get-ChildItem -Filter "*.config.template" -Recurse | Rename-Item -NewName {$_.name -replace '.config.template','.config' }

- task: VSBuild@1
  displayName: 'Build solution DFC.Digital/Seleno.BrowserStack.SpecFlowPlugin.sln'
  inputs:
    solution: DFC.Digital/Seleno.BrowserStack.SpecFlowPlugin.sln
    platform: 'Any CPU'
    configuration: Release

- task: SonarSource.sonarcloud.14d9cde6-c1da-4d55-aa01-2965cd301255.SonarCloudPrepare@1
  displayName: 'Prepare analysis on SonarCloud'
  inputs:
    SonarCloud: '$(SonarCloud)'
    organization: '$(Organization)'
    projectKey: '$(SonarCloudKey)'
    projectName: 'mk-dfc-digital'

- task: VSBuild@1
  displayName: 'Build solution DFC.Digital/DFC.Digital.sln'
  inputs:
    solution: DFC.Digital/DFC.Digital.sln
    msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactstagingdirectory)\\"'
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'

- task: VSTest@2
  displayName: 'VsTest - testAssemblies'
  inputs:
    testAssemblyVer2: |
     **\$(BuildConfiguration)\*UnitTests.dll
     !**\obj\**
    runSettingsFile: DFC.Digital/DFC.Digital.Tests.runsettings
    codeCoverageEnabled: true
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'

- task: SonarSource.sonarcloud.ce096e50-6155-4de8-8800-4221aaeed4a1.SonarCloudAnalyze@1
  displayName: 'Run Code Analysis'

- task: SonarSource.sonarcloud.38b27399-a642-40af-bb7d-9971f69712e8.SonarCloudPublish@1
  displayName: 'Publish Quality Gate Result'
  inputs:
    pollingTimeoutSec: 600
  continueOnError: true

- task: mspremier.BuildQualityChecks.QualityChecks-task.BuildQualityChecks@4
  displayName: 'Check build quality'
  inputs:
    checkCoverage: true
    coverageDeltaType: percentage
    buildConfiguration: '$(BuildConfiguration)'
    buildPlatform: '$(BuildPlatform)'
    baseDefinitionId: 1
    baseRepoId: 'Muthuramana/dfc-digital'
  continueOnError: true

- task: PublishSymbols@1
  displayName: 'Publish symbols path: '
  inputs:
    SearchPattern: '**\bin\**\*.pdb'
  continueOnError: true

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
  inputs:
    PathtoPublish: '$(build.artifactstagingdirectory)'
